# 機能仕様書

- バージョン: 0.4 (ドラフト)
- 更新日: YYYY-MM-DD
- 作成者: 

## 1. 概要
- オンライン対戦型マインスイーパー（観戦なし）。ターン制 1v1、共有盤面・共有フラグを前提にコアルールと進行を定義する。

## 2. ユースケース
- UC-01 ルーム作成（ホスト）
  - アクター: ホスト
  - 事前条件: なし
  - 事後条件: ルーム ID/URL が発行され、設定が編集可能
- UC-02 ルーム参加（プレイヤー）
  - アクター: 参加者
  - 事前条件: ルーム ID/URL を保有
  - 事後条件: プレイヤー一覧に表示、準備完了
- UC-03 ゲーム開始（同時スタート）
  - アクター: ホスト
  - 事前条件: ルームに 2 人以上のプレイヤー
  - 事後条件: サーバーで盤面生成（対戦ルールに応じて）、全員に初期状態配信し同時開始（Ready は不要）
- UC-04 手番の操作（Reveal/Flag/Chord）
  - アクター: 参加者
  - 事前条件: ゲーム進行中、かつ自分のターン
  - 事後条件: サーバーで判定し共有盤面/スコア/時計へ反映（連鎖開放含む）。ターン交代。
- UC-05 旗の設置/解除（Flag/Unflag）
  - アクター: 参加者
  - 事前条件: 対象セルが未開、かつ自分のターン
  - 事後条件: フラグ状態が更新され全員に反映
- UC-06 チョード（数字セルの周囲一括開放）
  - アクター: 参加者
  - 事前条件: 数字セルの周囲の旗数が数字と一致、かつ自分のターン
  - 事後条件: 安全セルが一括で開放（誤りがあれば敗北＝地雷ヒット）
- UC-07 時間切れ
  - アクター: 参加者
  - 事前条件: 自分の持ち時間が 0 に到達
  - 事後条件: 自動で敗北。ゲーム終了イベントを配信
- UC-08 地雷を開く（誤爆）
  - アクター: 参加者
  - 事前条件: 地雷セルを開いてしまう/誤チョードで地雷が開く
  - 事後条件: 即敗北。ゲーム終了イベントを配信
- UC-07 リスタート
  - アクター: ホスト
  - 事後条件: 新しいシードで再開（初手セーフ維持）
- UC-08 退出/再接続
  - アクター: 参加者
  - 事後条件: 状態復元、再接続時に最新スナップショットを配信

## 3. ユーザーストーリー（例）
- ルーム参加
  - Given: ルーム URL を知っている
  - When: ニックネームを入力して参加する
  - Then: プレイヤー一覧に表示され、ゲーム開始を待機できる
- セルを開く
  - Given: ゲームが開始しており、対象セルは未開
  - When: セルを開く操作を送信
  - Then: サーバー判定後、開放結果が全員の画面に反映される

- ## 4. 画面/フロー（MVP）
- ルーム画面: プレイヤー一覧、共有の盤面、二人のチェスクロック、スコア/進捗、手番インジケータ
- 設定モーダル: 盤面サイズ/地雷数、初手セーフ ON 固定（MVP）
 - モバイル操作: タップ=開く、長押し=旗、ピンチズーム/パン

## 5. 権限・ロール
- ホスト: 設定編集、開始、リスタート
- 参加者: 開く/旗/チョード、退出

## 6. 入力/バリデーション
- ニックネーム: 必須、1〜20 文字、絵文字可（UTF-8）
- ルーム ID: 英数字 6〜8 桁（URL 共有）
- 盤面: 幅/高さ（デフォルト: 16x16、最小: 16x16、例: 上級 30x16/99）、地雷数の上限は (幅×高さ-1) 未満

## 7. エラー/例外
- ルーム満員、存在しない/終了済みルーム、無効な操作順序（例: 既に開いているセルの再開）
- 再接続時のトークン失効

## 8. ログ/トラッキング
- ルーム作成/参加、ゲーム開始/終了、盤面設定、主要操作件数

## 9. 受け入れ基準
- AC-01: スタートは全員同時に始まり、タイマー同期誤差 < 100ms（同一地域）
- AC-02: 初手は必ず地雷を踏まない
- AC-03: 再接続で最新状態が復元される
- AC-04: 進捗/勝敗が全クライアントで一致する
 - AC-05: 自分のターンのみ操作を受理し、1手実行後に必ずターン交代する

## 10. フラグ共有（MVP方針）
- 旗はルーム内で共有され、設置/解除が全員に同期される。
- チョード判定は共有フラグ数を参照する。
- 旗が立っているセルは全員の盤面で開けない（解除が必要）。

## 11. ターン制ルール（Blitz Duel）
- 時間管理: チェスクロック（初期60秒、手番ごとに +2秒）。
- 手番: 1手 = 開く/旗/チョード のいずれか。実行後にターン交代。
- 勝敗条件（優先順）: ①地雷ヒット即負け ②時間切れ負け ③盤面解了時はスコア勝ち。
- スコア: 安全セル +1、正しい旗 +1、誤旗 -2（解除時）。
- 連鎖ボーナス: 連鎖規模に応じて自分の時計 -0.2〜-1.0s（上限1.0s）。
- タイブレーク: 総スコア → 誤爆数（少） → 総消費時間（少） → サドンデス1手。
- アンチ停滞: 旗のみの手を3連続は不可（次手は開くかチョード必須）。
