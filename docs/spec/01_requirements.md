# 要件定義書

- バージョン: 0.3 (ドラフト)
- 更新日: YYYY-MM-DD
- 作成者: 

## 1. 目的 / 背景
- マインスイーパーをオンラインで対戦（競争）できる体験を提供する。
- まずは「対戦プレイ（観戦なし）」を MVP として実装する。

## 2. スコープ
- 対象範囲 (MVP)
  - ルーム作成/参加（ニックネームのみ、アカウント不要）
  - 対戦プレイ（ターン制 1v1、共有盤面・共有フラグ）
  - 難易度/盤面サイズ/地雷数の設定
  - ゲーム開始/終了/リスタート
  - ターン/持ち時間/スコアの同期（勝敗判定含む）
- 対象外 (MVP 後)
  - 観戦モード、ランクマッチ、ランキング、フレンド機能
  - 永続的なアカウント管理/ソーシャルログイン
- 対応プラットフォーム/環境
  - Web アプリ（主にスマホ端末を対象。PC も対応）
  - スマホ最適化: タップ=開く、長押し=旗、ピンチズーム/パン対応

## 3. ペルソナ / 想定ユーザー
- カジュアルゲーマー、パズル好き、短時間で競争したいユーザー

## 4. 用語定義
- ルーム: プレイのためのセッション単位（コード/URLで共有）
- ホスト: ルームを作成し設定/開始操作ができる参加者
- 参加者: ルームに参加して操作するユーザー
- 盤面: 幅×高さのグリッド。地雷セル/数字セル/空セルを含む
- チョード(Chord): 数字セル上で隣接旗数が一致した場合の一括開放

## 5. ビジネス要件
- 無料で手軽に始められること（ゲストプレイ）
- シェアしやすいこと（ルームリンク/コード）
- 継続率の向上（短い 1 プレイ、リスタート容易）

## 6. 機能要件（ハイレベル）
- ルーム管理: 作成、参加、退出、ホスト移譲（ホスト離脱時）
- 盤面設定: 難易度（初級/中級/上級/カスタム）、サイズ、地雷数（デフォルトは 16x16/40）
- ゲーム進行（ターン制）: 1手=開く/旗/チョード、チェスクロック（初期60s、手番ごと+2s）
- 同期: ターン/時計/スコア/終了イベントをリアルタイム共有
- フェアネス: サーバー権威で不正操作を防止
- リカバリ: 再接続時の状態復元

## 7. 勝敗条件 / ルール（ターン制）
1) 地雷ヒット: 即敗北（サドンデス）
2) 持ち時間切れ: 該当プレイヤーの負け
3) 盤面解了: スコアが高い方の勝ち（同点はタイブレーク）

スコア: 安全セル開放 +1、正しい旗 +1、誤旗 -2（解除時）。連鎖ボーナス: 連鎖規模に応じて自分の時計を -0.2〜-1.0s（上限1.0s）。
誤チョード: 即敗北（旗の誤りにより地雷を開く扱い）。
アンチ停滞: 旗のみの手を3連続は不可（次手は開くかチョード必須）。

## 8. 非機能要件（参照: 03_nonfunctional_requirements.md）
- レイテンシ: 操作から画面反映まで P95 < 200ms（同一地域）
- 可用性: ライフタイムはルーム滞在中に限り 99% 目標（MVP）
- セキュリティ: クライアントからは地雷位置を推測できない設計

## 9. 制約 / 前提条件
- リアルタイム通信（WebSocket）を用いる（詳細は ADR 参照）
- サーバー権威モデル: 盤面生成と判定はサーバーで実行
- 初手セーフ: 最初の 1 手は必ず地雷を踏まない
- ランタイム/ホスティング: Cloudflare Workers + Durable Objects（ADR-0003）
- フロント: Vite + React を Cloudflare Pages にデプロイ
- 型/検証: TypeScript + Zod、WS は JSON
 - ストレージ: ルーム状態は Durable Objects に保持（MVP）。将来は D1 を試合履歴等に採用、KV はキャッシュ用途（ADR-0004）

## 10. リスクと対応
- 高レイテンシ/パケットロス: 操作の冪等化/再送、サーバー側直列処理
- 荒らし行為: ルームのキック/ミュート（将来対応）
- 同時操作競合: （共有盤面方式の場合）サーバー順序付けと先着処理

## 11. 依存関係
- 無し（MVP）。CDN/画像配信等は一般的な選定の範囲
 - 将来: Google アカウントログイン（MVP 対象外、将来対応予定のメモ）

## 12. 成功指標
- 平均プレイ時間、1 セッション内のリスタート回数
- ルーム作成からゲーム開始までの離脱率
- 勝敗判定までの平均所要時間
